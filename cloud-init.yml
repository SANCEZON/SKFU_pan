#cloud-config
# Cloud-init —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VPS TimeWeb
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VPS –≤ –ø–∞–Ω–µ–ª–∏ TimeWeb

users:
  - name: devuser
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys: 
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBJf47Vq9i+EkikK8kQLgCqti4eWbuyRwdcP2QxqChaA sancezon68@gmail.com

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
package_update: true
package_upgrade: true

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
packages:
  - curl
  - wget
  - git
  - ufw
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - nginx

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
ssh_pwauth: false

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
runcmd:
  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
  - |
    if ! command -v docker &> /dev/null; then
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
      systemctl enable docker
      systemctl start docker
      sleep 5
    fi

  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
  - usermod -aG docker devuser

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20.x
  - |
    if ! command -v node &> /dev/null; then
      curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      apt-get install -y nodejs
    fi

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pnpm
  - |
    if ! command -v pnpm &> /dev/null; then
      npm install -g pnpm
    fi

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp

  # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
  - mkdir -p /opt/attendance-panel
  - chown devuser:devuser /opt/attendance-panel

  # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  - |
    cd /opt/attendance-panel
    sudo -u devuser git clone https://github.com/SANCEZON/SKFU_pan.git . || true
    chown -R devuser:devuser /opt/attendance-panel

  # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
  - |
    cat > /opt/attendance-panel/.env << 'ENVEOF'
    DB_ROOT_PASSWORD=4z1NRLHucMPWySdthAGQ
    DB_USER=app_user
    DB_PASSWORD=4z1NRLHucMPWySdthAGQ
    DB_NAME=attendance_db
    JWT_SECRET=j4KEHMlw826oNbQaeTSGLkxuyP9ZnDCriUgFO7qW
    CORS_ORIGIN=http://89.169.3.134
    ENVEOF
    chown devuser:devuser /opt/attendance-panel/.env
    chmod 600 /opt/attendance-panel/.env

  # –°–æ–∑–¥–∞–Ω–∏–µ .env.production –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
  - |
    cat > /opt/attendance-panel/.env.production << 'PRODENVEOF'
    VITE_API_URL=http://89.169.3.134/api
    PRODENVEOF
    chown devuser:devuser /opt/attendance-panel/.env.production

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
  - |
    cd /opt/attendance-panel
    chown -R devuser:devuser /opt/attendance-panel
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    sudo -u devuser bash -c "cd /opt/attendance-panel && pnpm install" || {
      echo "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞..."
      sleep 5
      sudo -u devuser bash -c "cd /opt/attendance-panel && pnpm install"
    }
    
    # –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫ TypeScript
    sudo -u devuser bash -c "cd /opt/attendance-panel && pnpm build --mode production" || {
      echo "‚ö†Ô∏è –û—à–∏–±–∫–∏ TypeScript –ø—Ä–∏ —Å–±–æ—Ä–∫–µ, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤..."
      sudo -u devuser bash -c "cd /opt/attendance-panel && pnpm build:skip-types --mode production" || {
        echo "‚ö†Ô∏è –°–±–æ—Ä–∫–∞ —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
        sudo -u devuser bash -c "cd /opt/attendance-panel && pnpm exec vite build --mode production" || true
      }
    }
    
    # –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è dist –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    for i in {1..30}; do
      if [ -d /opt/attendance-panel/dist ]; then
        echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist —Å–æ–∑–¥–∞–Ω–∞"
        break
      fi
      echo "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è dist... ($i/30)"
      sleep 2
    done
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ dist –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -d /opt/attendance-panel/dist ]; then
      chown -R www-data:www-data /opt/attendance-panel/dist
      chmod -R 755 /opt/attendance-panel/dist
      echo "–ü—Ä–∞–≤–∞ –Ω–∞ dist —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
      echo "–í–ù–ò–ú–ê–ù–ò–ï: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
    fi

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
  - |
    cat > /etc/nginx/sites-available/attendance-panel << 'NGINXEOF'
    server {
        listen 80;
        server_name _;

        root /opt/attendance-panel/dist;
        index index.html;

        access_log /var/log/nginx/attendance-panel-access.log;
        error_log /var/log/nginx/attendance-panel-error.log;

        location / {
            try_files $uri $uri/ /index.html;
            
            location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        location /api {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        location /phpmyadmin {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        client_max_body_size 10M;
    }
    NGINXEOF

  # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
  - ln -sf /etc/nginx/sites-available/attendance-panel /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t || true
  - systemctl reload nginx || systemctl restart nginx

  # –°–æ–∑–¥–∞–Ω–∏–µ systemd service –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
  - |
    cat > /etc/systemd/system/attendance-panel.service << 'SERVICEEOF'
    [Unit]
    Description=Attendance Panel Docker Compose
    Requires=docker.service
    After=docker.service network.target

    [Service]
    Type=oneshot
    RemainAfterExit=yes
    WorkingDirectory=/opt/attendance-panel
    ExecStart=/usr/bin/docker compose -f docker-compose.prod.yml up -d
    ExecStop=/usr/bin/docker compose -f docker-compose.prod.yml down
    TimeoutStartSec=0
    User=root
    Restart=on-failure

    [Install]
    WantedBy=multi-user.target
    SERVICEEOF

  # –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
  - systemctl daemon-reload
  - systemctl enable attendance-panel.service

  # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Docker –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
  - |
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Docker
    for i in {1..30}; do
      if docker info > /dev/null 2>&1; then
        echo "Docker –≥–æ—Ç–æ–≤"
        break
      fi
      echo "–û–∂–∏–¥–∞–Ω–∏–µ Docker... ($i/30)"
      sleep 2
    done
    
    # –ó–∞–ø—É—Å–∫ Docker Compose —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π rate limit
    cd /opt/attendance-panel
    
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    start_docker_compose() {
      local max_attempts=5
      local delay=60  # –ù–∞—á–∏–Ω–∞–µ–º —Å 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è rate limit
      
      for attempt in $(seq 1 $max_attempts); do
        echo "–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ Docker Compose ($attempt/$max_attempts)..."
        
        if docker compose -f docker-compose.prod.yml up -d 2>&1 | tee /tmp/docker-compose.log; then
          echo "Docker Compose —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
          return 0
        fi
        
        if grep -qi "rate limit" /tmp/docker-compose.log || grep -qi "429" /tmp/docker-compose.log; then
          echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω rate limit Docker Hub, –æ–∂–∏–¥–∞–Ω–∏–µ ${delay} —Å–µ–∫—É–Ω–¥..."
          echo "üí° –°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ Docker Hub –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞"
          sleep $delay
          delay=$((delay + 60))  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π (60, 120, 180...)
        else
          echo "‚ö†Ô∏è –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥..."
          sleep 15
        fi
      done
      
      echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker Compose –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
      echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: cat /tmp/docker-compose.log"
      return 1
    }
    
    start_docker_compose || {
      echo "‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫–∏ Docker Compose..."
      echo "–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø–æ–∑–∂–µ:"
      echo "  cd /opt/attendance-panel"
      echo "  docker compose -f docker-compose.prod.yml up -d"
    }
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    sleep 20
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
    docker compose -f docker-compose.prod.yml ps || true

# –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
write_files:
  - path: /opt/attendance-panel/cloud-init-complete.log
    content: |
      Cloud-init –∑–∞–≤–µ—Ä—à—ë–Ω: $(date)
      
      –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:
      - Docker: $(docker --version 2>/dev/null || echo "–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      - Node.js: $(node --version 2>/dev/null || echo "–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      - pnpm: $(pnpm --version 2>/dev/null || echo "–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      - –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω: $([ -d /opt/attendance-panel/dist ] && echo "–¥–∞" || echo "–Ω–µ—Ç")
      
      –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:
      cd /opt/attendance-panel
      docker compose -f docker-compose.prod.yml ps
      docker compose -f docker-compose.prod.yml logs
    owner: devuser:devuser
    permissions: '0644'

# –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
final_message: |
  ‚úÖ Cloud-init –∑–∞–≤–µ—Ä—à—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
  
  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://89.169.3.134
  
  –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
  1. –õ–æ–≥–∏: docker compose -f docker-compose.prod.yml logs
  2. –°—Ç–∞—Ç—É—Å: docker compose -f docker-compose.prod.yml ps
  3. Nginx: sudo systemctl status nginx